{
  "name": "üü¢ Modular Voice Subflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "generate-story-voice",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        -352
      ],
      "id": "960297b9-e912-471a-9136-30e2512a2ab3",
      "name": "Webhook",
      "webhookId": "75f870d9-3190-43eb-8159-5b159a74f56b"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{\n  JSON.stringify({\n    id:\n      'https://pub-4805fa7fcbc0475a8824e062d1c298ed.r2.dev/' +\n      $('Webhook').item.json.body.metadata.drive_folder_id +\n      '/' +\n      $('Webhook').item.json.body.metadata.scene +\n      '.mp3'\n  })\n}}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        1472,
        -368
      ],
      "id": "e43945f3-dbe0-4c17-9154-63703e47a55f",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://texttospeech.googleapis.com/v1beta1/text:synthesize",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleOAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"input\": {\n    \"text\": {{ JSON.stringify($node[\"Safety Refiner\"]?.json?.output || $node[\"Webhook\"].json.body.text) }},\n    \"prompt\": \"Say this like a professional Hindi storyteller. Use a motivation tone.\"\n  },\n  \"voice\": {\n    \"languageCode\": \"{{ $('Webhook').item.json.body.voice_config.languageCode }}\",\n    \"name\": \"{{ $('Webhook').item.json.body.voice_config.name }}\", \n    \"model_name\": \"gemini-2.5-flash-tts\"\n  },\n  \"audioConfig\": {\n    \"audioEncoding\": \"LINEAR16\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        800,
        -208
      ],
      "id": "5f628038-09a7-4a8d-b7a3-f25433aa3a4a",
      "name": "Google TTS Engine",
      "credentials": {
        "googleOAuth2Api": {
          "id": "AEwxvSw5KqpWc1eO",
          "name": "Google OAuth TTS Chalta Purza"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const base64Data = $json.audioContent;\n\nreturn [{\n    binary: {\n        data: {\n            data: base64Data,\n            mimeType: \"audio/mpeg\",\n            fileName: \"voice.mp3\"\n        }\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        -208
      ],
      "id": "d26064b8-d94c-485e-be21-272468fb6e20",
      "name": "Base64 to Binary"
    },
    {
      "parameters": {
        "operation": "upload",
        "bucketName": "yt-scenes",
        "fileName": "={{ $('Webhook').item.json.body.metadata.drive_folder_id }}/{{ $('Webhook').item.json.body.metadata.scene }}.mp3",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.s3",
      "typeVersion": 1,
      "position": [
        1248,
        -368
      ],
      "id": "a097771f-8c59-4c9d-bafb-776ae65304c8",
      "name": "Upload Audio",
      "credentials": {
        "s3": {
          "id": "2xEMopykliclEARw",
          "name": "S3 (R2 Cloudfare)"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        304,
        -128
      ],
      "id": "af717311-c913-483e-9a01-d86b8920eb89",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "jO6VbRjkjpgUONmk",
          "name": "Gemini Text Generation Chalta Purza"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Input Text: {{ JSON.stringify($json.body.text) }}\n",
        "options": {
          "systemMessage": "You are a professional Hindi Script Editor. Your only job is to rewrite storytelling narration to bypass strict AI safety filters while keeping the emotional drama.\nRules:\nReplace words like 'kill', 'murder', 'blood', 'hate' with dramatic metaphors like 'defeat', 'end of time', 'darkness', 'deep anger'.\nMaintain the 'Filmy' Hindi style and dialogue.\nReturn ONLY the rewritten Hindi text.\nIf the text is already safe, return it exactly as it is."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        224,
        -352
      ],
      "id": "951c3284-fafb-40d0-90d4-89d2b6c0cf21",
      "name": "Safety Refiner",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://eastus.tts.speech.microsoft.com/cognitiveservices/v1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Ocp-Apim-Subscription-Key",
              "value": "1tOqDqG1zBdSKLhzwhm5qztNkVyLRPZW2ugqCoIsZ5gNc74TY2gOJQQJ99CAACYeBjFXJ3w3AAAAACOGH699"
            },
            {
              "name": "X-Microsoft-OutputFormat",
              "value": "riff-24khz-16bit-mono-pcm"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/ssml+xml",
        "body": "=<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='hi-IN'>     <voice name='hi-IN-ArjunNeural'>         \n<prosody rate='0.90' pitch='-10%'>             \n{{ $node[\"Safety Refiner\"].json.output.replace(/Narration:|‡§®‡•à‡§∞‡•á‡§∂‡§®:/gi, \"\").replace(/‡•§/g, '‡•§ <break time=\"600ms\"/>') }}         \n</prosody>     \n</voice> \n</speak>",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 21
            }
          },
          "response": {}
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1008,
        -368
      ],
      "id": "d79d67ad-6c1a-4471-b8bb-61dfcbe73c4c",
      "name": "Azure TTS"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3dafa53a-e63d-4108-9c1d-5da88eb29215",
              "leftValue": "={{ $('Webhook').item.json.body.metadata.tts_provider }}",
              "rightValue": "azure",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        576,
        -352
      ],
      "id": "1fc0d1db-fada-46ac-bcb9-44a00cc416dc",
      "name": "If"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "n8n.tinysaas.fun",
            "user-agent": "axios/1.12.0",
            "content-length": "1030",
            "accept": "application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "10.0.1.1",
            "x-forwarded-host": "n8n.tinysaas.fun",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "be92d452a53d",
            "x-real-ip": "10.0.1.1"
          },
          "params": {},
          "query": {},
          "body": {
            "text": "‡§è‡§ï ‡§∏‡§Æ‡§Ø ‡§ï‡•Ä ‡§¨‡§æ‡§§ ‡§π‡•à, ‡§è‡§ï ‡§π‡§≤‡§ö‡§≤ ‡§≠‡§∞‡•á ‡§∂‡§π‡§∞ ‡§ï‡•á ‡§∂‡•ã‡§∞‡§ó‡•Å‡§≤ ‡§Æ‡•á‡§Ç, ‡§∞‡§ø‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•Ä ‡§è‡§ï ‡§≤‡§°‡§º‡§ï‡•Ä ‡§∞‡§π‡§§‡•Ä ‡§•‡•Ä‡•§ ‡§â‡§∏‡§ï‡§æ ‡§∏‡§™‡§®‡§æ ‡§•‡§æ ‡§è‡§ï ‡§∏‡§´‡§≤ ‡§≤‡•á‡§ñ‡§ø‡§ï‡§æ ‡§¨‡§®‡§®‡•á ‡§ï‡§æ, ‡§≤‡•á‡§ï‡§ø‡§® ‡§â‡§∏‡§ï‡•á ‡§π‡§∞ ‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§ö‡•Å‡§®‡•å‡§§‡§ø‡§Ø‡§æ‡§Å ‡§â‡§∏‡•á ‡§Ö‡§™‡§®‡•Ä ‡§ß‡•Å‡§® ‡§∏‡•á ‡§≠‡§ü‡§ï‡§æ ‡§∞‡§π‡•Ä ‡§•‡•Ä‡§Ç‡•§ ‡§â‡§∏‡§ï‡•Ä ‡§°‡§æ‡§Ø‡§∞‡•Ä ‡§ï‡•á ‡§™‡§®‡•ç‡§®‡•á ‡§ñ‡§æ‡§≤‡•Ä ‡§™‡§°‡§º‡•á ‡§•‡•á, ‡§î‡§∞ ‡§∞‡§ö‡§®‡§æ‡§§‡•ç‡§Æ‡§ï‡§§‡§æ ‡§ï‡§æ ‡§ù‡§∞‡§®‡§æ ‡§Æ‡§æ‡§®‡•ã ‡§∏‡•Ç‡§ñ ‡§∏‡§æ ‡§ó‡§Ø‡§æ ‡§•‡§æ‡•§ ‡§µ‡§π ‡§π‡§∞ ‡§∏‡•Å‡§¨‡§π ‡§è‡§ï ‡§®‡§à ‡§ï‡§π‡§æ‡§®‡•Ä ‡§ï‡•Ä ‡§§‡§≤‡§æ‡§∂ ‡§Æ‡•á‡§Ç ‡§â‡§†‡§§‡•Ä, ‡§™‡§∞ ‡§®‡§ø‡§∞‡§æ‡§∂‡§æ ‡§π‡•Ä ‡§π‡§æ‡§• ‡§≤‡§ó‡§§‡•Ä‡•§",
            "prompt": "Say the following like you are narrating a story",
            "voice_config": {
              "languageCode": "en-us",
              "name": "Kore",
              "model_name": "gemini-2.5-flash-tts"
            },
            "metadata": {
              "scene": 1,
              "drive_folder_id": "story_2026-01-09T16-51-52-960Z"
            }
          },
          "webhookUrl": "https://n8n.tinysaas.fun/webhook/generate-story-voice",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Safety Refiner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google TTS Engine": {
      "main": [
        [
          {
            "node": "Base64 to Binary",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Base64 to Binary": {
      "main": [
        [
          {
            "node": "Upload Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Audio": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Safety Refiner",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Safety Refiner": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Azure TTS": {
      "main": [
        [
          {
            "node": "Upload Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Azure TTS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Google TTS Engine",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "2c56ef23-015a-451d-8389-5ce349158235",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "26999db1e681e6a87364716419329ff310f36bdcdb3a6fae594cdba3a86aed90"
  },
  "id": "eyBlpx5kOPkJBJXB",
  "tags": []
}